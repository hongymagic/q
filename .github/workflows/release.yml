name: Release

on:
  push:
    branches: [main]
    tags:
      # CalVer pattern: vYYYY.MMDD.PATCH (e.g., v2026.0226.0)
      - "v[0-9][0-9][0-9][0-9].[0-9][0-9][0-9][0-9].[0-9]*"

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  id-token: write

jobs:
  # Determine release type and version
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
      should_release: ${{ steps.version.outputs.should_release }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            # Tagged release
            TAG="${GITHUB_REF#refs/tags/v}"
            echo "Processing tag: v${TAG}"

            # Validate CalVer format: YYYY.MMDD.PATCH
            if [[ ! "$TAG" =~ ^[0-9]{4}\.[0-9]{4}\.[0-9]+$ ]]; then
              echo "::error::Tag must match CalVer format: vYYYY.MMDD.PATCH (e.g., v2026.0226.0)"
              exit 1
            fi

            # Extract and validate date
            YEAR="${TAG:0:4}"
            MMDD="${TAG:5:4}"
            TODAY_YEAR=$(date -u +"%Y")
            TODAY_MMDD=$(date -u +"%m%d")

            if [[ "${YEAR}.${MMDD}" != "${TODAY_YEAR}.${TODAY_MMDD}" ]]; then
              echo "::error::Tag date ${YEAR}.${MMDD} does not match today's date ${TODAY_YEAR}.${TODAY_MMDD} (UTC)"
              exit 1
            fi

            echo "version=$TAG" >> $GITHUB_OUTPUT
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "::notice::Stable release: v${TAG}"
          else
            # Main branch push - pre-release
            YEAR=$(date -u +"%Y")
            MONTH=$(date -u +"%m")
            DAY=$(date -u +"%d")
            DATE="${YEAR}.${MONTH}${DAY}"
            SHORT_SHA=$(git rev-parse --short HEAD)

            # Find today's latest stable tag to calculate PATCH
            LATEST_TAG=$(git tag -l "v${DATE}.*" 2>/dev/null | grep -v '-' | sort -V | tail -1)
            if [ -z "$LATEST_TAG" ]; then
              PATCH=0
            else
              PATCH=$((${LATEST_TAG##*.} + 1))
            fi

            VERSION="${DATE}.${PATCH}-next.${SHORT_SHA}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "::notice::Pre-release: ${VERSION}"
          fi

  # Build platform binaries (only for stable releases)
  build:
    name: Build (${{ matrix.target }})
    needs: prepare
    if: needs.prepare.outputs.is_prerelease == 'false'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - target: darwin-arm64
            os: macos-latest
          - target: darwin-x64
            os: macos-latest
          - target: linux-x64
            os: ubuntu-latest
          - target: linux-arm64
            os: ubuntu-latest
          - target: windows-x64
            os: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - run: bun install --frozen-lockfile

      - name: Set package version
        run: npm version ${{ needs.prepare.outputs.version }} --no-git-tag-version

      - name: Build for ${{ matrix.target }}
        run: bun run build:${{ matrix.target }}

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: q-${{ matrix.target }}
          path: dist/q-${{ matrix.target }}*

  # Create GitHub Release (only for stable releases)
  github-release:
    name: Create GitHub Release
    needs: [prepare, build]
    if: needs.prepare.outputs.is_prerelease == 'false'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          for dir in artifacts/*/; do
            cp "$dir"* release/
          done
          ls -la release/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          generate_release_notes: true
          name: "v${{ needs.prepare.outputs.version }}"

  # Publish to npm (both pre-releases and stable releases)
  publish-npm:
    name: Publish to npm
    needs: [prepare, github-release]
    # Run after github-release for stable, or directly for pre-release
    if: always() && needs.prepare.outputs.should_release == 'true' && (needs.prepare.outputs.is_prerelease == 'true' || needs.github-release.result == 'success')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - run: bun install --frozen-lockfile

      - name: Set package version
        run: npm version ${{ needs.prepare.outputs.version }} --no-git-tag-version

      - name: Build for npm
        run: bun run build:npm

      - uses: actions/setup-node@v6
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"

      - name: Publish to npm
        run: |
          if [[ "${{ needs.prepare.outputs.is_prerelease }}" == "true" ]]; then
            npm publish --provenance --access public --tag next
          else
            npm publish --provenance --access public
          fi

  # Sync version to main (only for stable releases)
  sync-version:
    name: Sync package.json version
    needs: [prepare, publish-npm]
    if: needs.prepare.outputs.is_prerelease == 'false' && needs.publish-npm.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update package.json version
        run: |
          npm version ${{ needs.prepare.outputs.version }} --no-git-tag-version

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json
          git commit -m "chore: bump version to ${{ needs.prepare.outputs.version }} [skip ci]"
          git push
